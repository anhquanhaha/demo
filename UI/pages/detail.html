<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case AI Agent - Chi ti·∫øt y√™u c·∫ßu</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Test Case AI Agent</h1>
            <p id="headerSubtitle">Chi ti·∫øt y√™u c·∫ßu</p>
        </div>
        
        <div class="main-content">
            <div class="nav-bar">
                <div class="nav-title">
                    <a href="../index.html" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
                    <span id="requestTitle">ƒêang t·∫£i...</span>
                </div>
                <div class="nav-actions">
                    <button class="btn btn-success" onclick="sendToAgent()" id="sendToAgentBtn">
                        üöÄ G·ª≠i cho AI Agent
                    </button>
                    <button class="btn btn-secondary" onclick="refreshMessages()">
                        üîÑ L√†m m·ªõi
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; min-height: 600px;">
                <!-- Request Info Panel -->
                <div style="padding: 30px; background: #f8f9fa; border-right: 1px solid #e9ecef;">
                    <h3 style="margin-bottom: 20px; color: #333;">üìã Th√¥ng tin y√™u c·∫ßu</h3>
                    
                    <div id="requestInfo">
                        <!-- Request info will be loaded here -->
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 15px; color: #333;">üìé G·ª≠i file ƒë√≠nh k√®m</h4>
                        <div class="form-group">
                            <div class="file-input-wrapper">
                                <div class="file-input">
                                    <input type="file" id="fileAttachment" accept="image/*,.txt,.md,.json,.xml">
                                    <span id="fileLabel">üìé Ch·ªçn file ƒë·ªÉ t·∫£i l√™n</span>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">H·ªó tr·ª£: ·∫¢nh, Text, Markdown, JSON, XML</small>
                    </div>
                </div>
                
                <!-- Chat Panel -->
                <div style="padding: 30px; background: #ffffff; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #333;">üí¨ Cu·ªôc tr√≤ chuy·ªán v·ªõi AI</h3>
                        <div>
                            <span class="status-indicator status-idle" id="statusIndicator"></span>
                            <span id="statusText">S·∫µn s√†ng</span>
                        </div>
                    </div>
                    
                    <div id="messagesContainer" style="flex: 1; max-height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary w-100" onclick="exportConversation()">
                            üìÑ Xu·∫•t cu·ªôc tr√≤ chuy·ªán
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentRequest = null;
        let currentMessages = [];
        let isStreaming = false;

        // Get conversation ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('id');

        if (!conversationId) {
            showToast('Kh√¥ng t√¨m th·∫•y ID y√™u c·∫ßu', 'error');
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 2000);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRequestData();
            setupFileInput();
        });

        /**
         * Load request data and messages
         */
        async function loadRequestData() {
            try {
                // Load request info
                currentRequest = await apiClient.getRequest(conversationId);
                displayRequestInfo(currentRequest);
                
                // Load messages
                await loadMessages();
                
            } catch (error) {
                console.error('Error loading request data:', error);
                showToast('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        /**
         * Display request information
         */
        function displayRequestInfo(request) {
            document.getElementById('requestTitle').textContent = request.title;
            document.getElementById('headerSubtitle').textContent = `Chi ti·∫øt y√™u c·∫ßu: ${request.title}`;
            
            const requestInfo = document.getElementById('requestInfo');
            requestInfo.innerHTML = `
                <div class="mb-3">
                    <strong>Ti√™u ƒë·ªÅ:</strong><br>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        ${request.title}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Conversation ID:</strong><br>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace; font-size: 0.9em;">
                        ${request.conversation_id}
                        <button class="btn btn-secondary btn-sm" style="margin-left: 10px;" 
                                onclick="copyToClipboard('${request.conversation_id}')" title="Sao ch√©p ID">
                            üìã
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Y√™u c·∫ßu PBI:</strong><br>
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 5px; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                        ${request.pbi_requirement.replace(/\n/g, '<br>')}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em; color: #666;">
                    <div>
                        <strong>T·∫°o:</strong><br>
                        ${formatDateTime(request.created_at)}
                    </div>
                    <div>
                        <strong>C·∫≠p nh·∫≠t:</strong><br>
                        ${formatDateTime(request.updated_at)}
                    </div>
                </div>
            `;
        }

        /**
         * Load messages from API
         */
        async function loadMessages() {
            try {
                currentMessages = await apiClient.getMessages(conversationId);
                displayMessages(currentMessages);
            } catch (error) {
                console.error('Error loading messages:', error);
                const container = document.getElementById('messagesContainer');
                showError(container, 'C√≥ l·ªói khi t·∫£i tin nh·∫Øn: ' + error.message);
            }
        }

        /**
         * Display messages in chat container
         */
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0) {
                showEmptyState(
                    container,
                    'Ch∆∞a c√≥ tin nh·∫Øn n√†o',
                    'Nh·∫•n "G·ª≠i cho AI Agent" ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán',
                    {
                        text: 'üöÄ G·ª≠i cho AI Agent',
                        onclick: 'sendToAgent()'
                    }
                );
                return;
            }

            container.innerHTML = messages.map(message => `
                <div class="message ${message.role}">
                    <div class="message-header">
                        <span class="message-role">
                            ${message.role === 'user' ? 'üë§ Ng∆∞·ªùi d√πng' : 'ü§ñ AI Agent'}
                        </span>
                        <span class="message-time">${formatDateTime(message.created_at)}</span>
                    </div>
                    <div class="message-content">
                        ${message.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        /**
         * Setup file input handler
         */
        function setupFileInput() {
            const fileInput = document.getElementById('fileAttachment');
            const fileLabel = document.getElementById('fileLabel');

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    fileLabel.textContent = `üìé ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                } else {
                    fileLabel.textContent = 'üìé Ch·ªçn file ƒë·ªÉ t·∫£i l√™n';
                }
            });
        }

        /**
         * Send request to AI Agent
         */
        async function sendToAgent() {
            if (isStreaming) {
                showToast('ƒêang x·ª≠ l√Ω y√™u c·∫ßu tr∆∞·ªõc ƒë√≥...', 'warning');
                return;
            }

            if (!currentRequest) {
                showToast('Ch∆∞a t·∫£i ƒë∆∞·ª£c th√¥ng tin y√™u c·∫ßu', 'error');
                return;
            }

            isStreaming = true;
            updateStatus('connecting', 'ƒêang k·∫øt n·ªëi...');
            
            const sendBtn = document.getElementById('sendToAgentBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...';

            // Get file attachment
            const fileInput = document.getElementById('fileAttachment');
            const fileAttachment = fileInput.files[0] || null;

            try {
                const response = await apiClient.sendToAgent(
                    conversationId,
                    currentRequest.title,
                    currentRequest.pbi_requirement,
                    fileAttachment
                );

                updateStatus('streaming', 'ƒêang nh·∫≠n d·ªØ li·ªáu...');
                
                // Clear file input
                fileInput.value = '';
                document.getElementById('fileLabel').textContent = 'üìé Ch·ªçn file ƒë·ªÉ t·∫£i l√™n';

                // Process streaming response
                await processStreamingResponse(response);

            } catch (error) {
                console.error('Error sending to agent:', error);
                updateStatus('error', 'C√≥ l·ªói x·∫£y ra');
                addStreamingMessage('error', `‚ùå L·ªói: ${error.message}`);
            } finally {
                isStreaming = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'üöÄ G·ª≠i cho AI Agent';
            }
        }

        /**
         * Process streaming response from agent
         */
        async function processStreamingResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let currentMessageContent = '';

            try {
                while (true) {
                    const { value, done } = await reader.read();
                    
                    if (done) {
                        updateStatus('complete', 'Ho√†n th√†nh');
                        break;
                    }

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleStreamData(data);
                            } catch (e) {
                                // Ignore JSON parse errors for incomplete chunks
                            }
                        }
                    }
                }
            } finally {
                // Reload messages to get the saved version
                setTimeout(() => {
                    loadMessages();
                }, 1000);
            }
        }

        /**
         * Handle streaming data
         */
        function handleStreamData(data) {
            switch (data.type) {
                case 'chunk':
                    appendToStreamingMessage(data.content);
                    break;
                    
                case 'message':
                    addStreamingMessage('assistant', data.content);
                    break;
                    
                case 'end':
                    updateStatus('complete', 'Ho√†n th√†nh');
                    break;
                    
                case 'error':
                    addStreamingMessage('error', `‚ùå L·ªói: ${data.message}`);
                    updateStatus('error', 'C√≥ l·ªói x·∫£y ra');
                    break;
            }
        }

        let currentStreamingMessage = null;

        /**
         * Add streaming message to chat
         */
        function addStreamingMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            
            // Remove empty state if exists
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-role">
                        ${role === 'user' ? 'üë§ Ng∆∞·ªùi d√πng' : role === 'assistant' ? 'ü§ñ AI Agent' : '‚ö†Ô∏è H·ªá th·ªëng'}
                    </span>
                    <span class="message-time">${formatDateTime(new Date().toISOString())}</span>
                </div>
                <div class="message-content">${content}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            if (role === 'assistant') {
                currentStreamingMessage = messageDiv.querySelector('.message-content');
            }
        }

        /**
         * Append content to current streaming message
         */
        function appendToStreamingMessage(content) {
            if (!currentStreamingMessage) {
                // Create new streaming message
                addStreamingMessage('assistant', content);
            } else {
                currentStreamingMessage.textContent += content;
                const container = document.getElementById('messagesContainer');
                container.scrollTop = container.scrollHeight;
            }
        }

        /**
         * Update status indicator
         */
        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }

        /**
         * Refresh messages
         */
        async function refreshMessages() {
            await loadMessages();
            showToast('Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi', 'success');
        }

        /**
         * Export conversation to file
         */
        function exportConversation() {
            if (!currentRequest || currentMessages.length === 0) {
                showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'warning');
                return;
            }

            let content = `# ${currentRequest.title}\n\n`;
            content += `**Conversation ID:** ${currentRequest.conversation_id}\n`;
            content += `**T·∫°o:** ${formatDateTime(currentRequest.created_at)}\n`;
            content += `**C·∫≠p nh·∫≠t:** ${formatDateTime(currentRequest.updated_at)}\n\n`;
            content += `## Y√™u c·∫ßu PBI\n\n${currentRequest.pbi_requirement}\n\n`;
            content += `## Cu·ªôc tr√≤ chuy·ªán\n\n`;

            currentMessages.forEach(message => {
                const role = message.role === 'user' ? 'üë§ Ng∆∞·ªùi d√πng' : 'ü§ñ AI Agent';
                content += `### ${role} - ${formatDateTime(message.created_at)}\n\n`;
                content += `${message.content}\n\n---\n\n`;
            });

            const filename = `testcase_${currentRequest.conversation_id}_${new Date().toISOString().split('T')[0]}.md`;
            downloadAsFile(content, filename, 'text/markdown');
            
            showToast('Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c xu·∫•t', 'success');
        }

        // Initialize status
        updateStatus('idle', 'S·∫µn s√†ng');
    </script>
</body>
</html>
