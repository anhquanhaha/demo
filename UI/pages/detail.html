<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case AI Agent - Chi ti·∫øt y√™u c·∫ßu</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Test Case AI Agent</h1>
            <p id="headerSubtitle">Chi ti·∫øt y√™u c·∫ßu</p>
        </div>

        <div class="main-content">
            <div class="nav-bar">
                <div class="nav-title">
                    <a href="../index.html" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
                    <span id="requestTitle">ƒêang t·∫£i...</span>
                </div>
                <div class="nav-actions">
                    <button class="btn btn-success" onclick="sendToAgent()" id="sendToAgentBtn">
                        üöÄ G·ª≠i cho AI Agent
                    </button>
                    <button class="btn btn-secondary" onclick="refreshMessages()">
                        üîÑ L√†m m·ªõi
                    </button>
                </div>
            </div>

            <!-- Main Layout: Left Panel (Tabs) + Right Panel (Chat) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; min-height: 600px;">
                <!-- Left Panel: Tab Content -->
                <div style="background: #f8f9fa; border-right: 1px solid #e9ecef;">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-button active" onclick="switchTab('request-info')" id="tab-request-info">
                            üìã Th√¥ng tin y√™u c·∫ßu
                        </button>
                        <button class="tab-button" onclick="switchTab('test-cases')" id="tab-test-cases">
                            üß™ Test Cases
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content-container">
                        <!-- Tab 1: Request Info -->
                        <div id="tab-content-request-info" class="tab-content active">
                            <div style="padding: 30px;">
                                <h3 style="margin-bottom: 20px; color: #333;">üìã Th√¥ng tin y√™u c·∫ßu</h3>

                                <div id="requestInfo">
                                    <!-- Request info will be loaded here -->
                                </div>

                                <div style="margin-top: 30px;">
                                    <h4 style="margin-bottom: 15px; color: #333;">üìé G·ª≠i file ƒë√≠nh k√®m</h4>
                                    <div class="form-group">
                                        <div class="file-input-wrapper">
                                            <div class="file-input">
                                                <input type="file" id="fileAttachment"
                                                    accept="image/*,.txt,.md,.json,.xml">
                                                <span id="fileLabel">üìé Ch·ªçn file ƒë·ªÉ t·∫£i l√™n</span>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">H·ªó tr·ª£: ·∫¢nh, Text, Markdown, JSON, XML</small>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 2: Test Cases -->
                        <div id="tab-content-test-cases" class="tab-content">
                            <div style="padding: 30px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h3 style="color: #333;">üß™ Test Cases ƒë∆∞·ª£c t·∫°o b·ªüi AI Agent</h3>
                                    <button class="btn btn-primary" onclick="refreshTestCases()">
                                        üîÑ L√†m m·ªõi
                                    </button>
                                </div>

                                <div id="testCasesContainer">
                                    <!-- Test cases table will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Chat (Always Visible) -->
                <div style="padding: 30px; background: #ffffff; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #333;">üí¨ Cu·ªôc tr√≤ chuy·ªán v·ªõi AI</h3>
                        <div>
                            <span class="status-indicator status-idle" id="statusIndicator"></span>
                            <span id="statusText">S·∫µn s√†ng</span>
                        </div>
                    </div>

                    <div id="messagesContainer"
                        style="flex: 1; max-height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <!-- Messages will be loaded here -->
                    </div>

                    <!-- <div style="margin-top: 15px;">
                        <button class="btn btn-primary w-100" onclick="exportConversation()">
                            üìÑ Xu·∫•t cu·ªôc tr√≤ chuy·ªán
                        </button>
                    </div> -->

                    <!-- Custom Message Input v·ªõi File Attachment -->
                    <div class="custom-message-input-container" style="margin-top: 15px;">
                        <!-- Input Area -->
                        <div class="custom-input-wrapper">
                            <div class="custom-input-area" id="messageInputArea" contenteditable="true" 
                                 data-placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..."></div>
                            
                            <!-- File Attachment Preview -->
                            <div class="file-attachment-preview" id="fileAttachmentPreview" style="display: none;">
                                <div class="file-info">
                                    <span class="file-icon">üìé</span>
                                    <span class="file-name" id="attachedFileName"></span>
                                    <span class="file-size" id="attachedFileSize"></span>
                                    <button class="file-remove-btn" onclick="removeFileAttachment()" title="X√≥a file">‚ùå</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="input-actions">
                            <input type="file" id="messageFileInput" accept="image/*,.txt,.md,.json,.xml,.pdf,.doc,.docx" style="display: none;">
                            <button class="btn btn-secondary" onclick="triggerFileSelect()" id="attachFileBtn">
                                üìé ƒê√≠nh k√®m
                            </button>
                            <button class="btn btn-primary" onclick="sendMessage()" id="sendMessageBtn">
                                üöÄ G·ª≠i tin nh·∫Øn
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentRequest = null;
        let currentMessages = [];
        let isStreaming = false;

        // Get conversation ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('id');

        if (!conversationId) {
            showToast('Kh√¥ng t√¨m th·∫•y ID y√™u c·∫ßu', 'error');
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 2000);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadRequestData();
            setupFileInput();
            loadTestCases();
        });

        /**
         * Load request data and messages
         */
        async function loadRequestData() {
            try {
                // Load request info
                currentRequest = await apiClient.getRequest(conversationId);
                displayRequestInfo(currentRequest);

                // Load messages
                await loadMessages();

            } catch (error) {
                console.error('Error loading request data:', error);
                showToast('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        /**
         * Display request information
         */
        function displayRequestInfo(request) {
            document.getElementById('requestTitle').textContent = request.title;
            document.getElementById('headerSubtitle').textContent = `Chi ti·∫øt y√™u c·∫ßu: ${request.title}`;

            const requestInfo = document.getElementById('requestInfo');
            requestInfo.innerHTML = `
                <div class="mb-3">
                    <strong>Ti√™u ƒë·ªÅ:</strong><br>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        ${request.title}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Conversation ID:</strong><br>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace; font-size: 0.9em;">
                        ${request.conversation_id}
                        <button class="btn btn-secondary btn-sm" style="margin-left: 10px;" 
                                onclick="copyToClipboard('${request.conversation_id}')" title="Sao ch√©p ID">
                            üìã
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Y√™u c·∫ßu PBI:</strong><br>
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 5px; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                        ${request.pbi_requirement.replace(/\n/g, '<br>')}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em; color: #666;">
                    <div>
                        <strong>T·∫°o:</strong><br>
                        ${formatDateTime(request.created_at)}
                    </div>
                    <div>
                        <strong>C·∫≠p nh·∫≠t:</strong><br>
                        ${formatDateTime(request.updated_at)}
                    </div>
                </div>
            `;
        }

        /**
         * Load messages from API
         */
        async function loadMessages() {
            try {
                currentMessages = await apiClient.getMessages(conversationId);
                displayMessages(currentMessages);
            } catch (error) {
                console.error('Error loading messages:', error);
                const container = document.getElementById('messagesContainer');
                showError(container, 'C√≥ l·ªói khi t·∫£i tin nh·∫Øn: ' + error.message);
            }
        }

        /**
         * Display messages in chat container
         */
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');

            if (messages.length === 0) {
                showEmptyState(
                    container,
                    'Ch∆∞a c√≥ tin nh·∫Øn n√†o',
                    'Nh·∫•n "G·ª≠i cho AI Agent" ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán',
                    {
                        text: 'üöÄ G·ª≠i cho AI Agent',
                        onclick: 'sendToAgent()'
                    }
                );
                return;
            }

            container.innerHTML = messages.map(message => `
                <div class="message ${message.role}">
                    <div class="message-header">
                        <span class="message-role">
                            ${message.role === 'user' ? 'üë§ Ng∆∞·ªùi d√πng' : 'ü§ñ AI Agent'}
                        </span>
                        <span class="message-time">${formatDateTime(message.created_at)}</span>
                    </div>
                    <div class="message-content">
                        ${message.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        /**
         * Setup file input handler
         */
        function setupFileInput() {
            const fileInput = document.getElementById('fileAttachment');
            const fileLabel = document.getElementById('fileLabel');

            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    fileLabel.textContent = `üìé ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                } else {
                    fileLabel.textContent = 'üìé Ch·ªçn file ƒë·ªÉ t·∫£i l√™n';
                }
            });
        }

        /**
         * Send request to AI Agent
         */
        async function sendToAgent() {
            if (isStreaming) {
                showToast('ƒêang x·ª≠ l√Ω y√™u c·∫ßu tr∆∞·ªõc ƒë√≥...', 'warning');
                return;
            }

            if (!currentRequest) {
                showToast('Ch∆∞a t·∫£i ƒë∆∞·ª£c th√¥ng tin y√™u c·∫ßu', 'error');
                return;
            }

            // Set loading state
            isStreaming = true;
            updateStatus('connecting', 'ƒêang k·∫øt n·ªëi...');

            const sendBtn = document.getElementById('sendToAgentBtn');
            const messageInput = document.getElementById('messageInput');
            
            // Update UI for loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...';
            
            // Disable input during processing
            messageInput.disabled = true;
            messageInput.placeholder = 'ƒêang x·ª≠ l√Ω y√™u c·∫ßu...';
            setInputLoadingState(true);

            // Get file attachment
            const fileInput = document.getElementById('fileAttachment');
            const fileAttachment = fileInput.files[0] || null;

            // Add typing indicator
            addTypingIndicator();

            try {
                const response = await apiClient.sendToAgent(
                    conversationId,
                    currentRequest.title,
                    currentRequest.pbi_requirement,
                    fileAttachment
                );

                updateStatus('streaming', 'AI ƒëang t·∫°o test case...');

                // Clear file input
                fileInput.value = '';
                document.getElementById('fileLabel').textContent = 'üìé Ch·ªçn file ƒë·ªÉ t·∫£i l√™n';

                // Remove typing indicator before processing response
                removeTypingIndicator();

                // Process streaming response
                await processStreamingResponse(response);

            } catch (error) {
                console.error('Error sending to agent:', error);
                updateStatus('error', 'C√≥ l·ªói x·∫£y ra');
                removeTypingIndicator();
                addStreamingMessage('error', `‚ùå L·ªói: ${error.message}`);
            } finally {
                // Reset UI state
                isStreaming = false;
                setInputLoadingState(false);
                updateStatus('idle', 'S·∫µn s√†ng');
                
                // Reset buttons and inputs
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'üöÄ G·ª≠i cho AI Agent';
                
                messageInput.disabled = false;
                messageInput.placeholder = 'Nh·∫≠p tin nh·∫Øn...';
            }
        }

        /**
         * Process streaming response from agent
         */
        async function processStreamingResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let currentMessageContent = '';

            try {
                while (true) {
                    const { value, done } = await reader.read();

                    if (done) {
                        updateStatus('complete', 'Ho√†n th√†nh');
                        break;
                    }

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleStreamData(data);
                            } catch (e) {
                                // Ignore JSON parse errors for incomplete chunks
                            }
                        }
                    }
                }
            } finally {
                // Reload messages to get the saved version
                setTimeout(() => {
                    loadMessages();
                }, 1000);
            }
        }

        /**
         * Handle streaming data
         */
        function handleStreamData(data) {
            switch (data.type) {
                case 'chunk':
                    // Remove user loading indicator when first AI response chunk arrives
                    removeUserLoadingIndicator();
                    appendToStreamingMessage(data.content);
                    break;

                case 'message':
                    // Remove user loading indicator when AI response starts
                    removeUserLoadingIndicator();
                    addStreamingMessage('assistant', data.content);
                    break;

                case 'end':
                    updateStatus('complete', 'Ho√†n th√†nh');
                    // Ensure user loading indicator is removed on completion
                    removeUserLoadingIndicator();
                    break;

                case 'error':
                    // Remove user loading indicator on error
                    removeUserLoadingIndicator();
                    addStreamingMessage('error', `‚ùå L·ªói: ${data.message}`);
                    updateStatus('error', 'C√≥ l·ªói x·∫£y ra');
                    break;
            }
        }

        let currentStreamingMessage = null;

        /**
         * Add streaming message to chat
         */
        function addStreamingMessage(role, content, isWaitingForResponse = false) {
            const container = document.getElementById('messagesContainer');

            // Remove empty state if exists
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Add loading dots to user message if waiting for response
            let messageContent = content;
            if (role === 'user' && isWaitingForResponse) {
                messageContent += ' <span class="user-loading-dots">...</span>';
                messageDiv.setAttribute('data-waiting', 'true');
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-role">
                        ${role === 'user' ? 'üë§ Ng∆∞·ªùi d√πng' : role === 'assistant' ? 'ü§ñ AI Agent' : '‚ö†Ô∏è H·ªá th·ªëng'}
                    </span>
                    <span class="message-time">${formatDateTime(new Date().toISOString())}</span>
                </div>
                <div class="message-content">${messageContent}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            if (role === 'assistant') {
                currentStreamingMessage = messageDiv.querySelector('.message-content');
            }
        }

        /**
         * Remove loading indicator from user message
         */
        function removeUserLoadingIndicator() {
            const waitingMessage = document.querySelector('.message[data-waiting="true"]');
            if (waitingMessage) {
                const loadingDots = waitingMessage.querySelector('.user-loading-dots');
                if (loadingDots) {
                    loadingDots.remove();
                }
                waitingMessage.removeAttribute('data-waiting');
            }
        }

        /**
         * Append content to current streaming message
         */
        function appendToStreamingMessage(content) {
            if (!currentStreamingMessage) {
                // Create new streaming message
                addStreamingMessage('assistant', content);
            } else {
                currentStreamingMessage.textContent += content;
                const container = document.getElementById('messagesContainer');
                container.scrollTop = container.scrollHeight;
            }
        }

        /**
         * Update status indicator
         */
        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }

        /**
         * Refresh messages
         */
        async function refreshMessages() {
            await loadMessages();
            showToast('Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi', 'success');
        }

        /**
         * Export conversation to file
         */
        function exportConversation() {
            if (!currentRequest || currentMessages.length === 0) {
                showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'warning');
                return;
            }

            let content = `# ${currentRequest.title}\n\n`;
            content += `**Conversation ID:** ${currentRequest.conversation_id}\n`;
            content += `**T·∫°o:** ${formatDateTime(currentRequest.created_at)}\n`;
            content += `**C·∫≠p nh·∫≠t:** ${formatDateTime(currentRequest.updated_at)}\n\n`;
            content += `## Y√™u c·∫ßu PBI\n\n${currentRequest.pbi_requirement}\n\n`;
            content += `## Cu·ªôc tr√≤ chuy·ªán\n\n`;

            currentMessages.forEach(message => {
                const role = message.role === 'user' ? 'üë§ Ng∆∞·ªùi d√πng' : 'ü§ñ AI Agent';
                content += `### ${role} - ${formatDateTime(message.created_at)}\n\n`;
                content += `${message.content}\n\n---\n\n`;
            });

            const filename = `testcase_${currentRequest.conversation_id}_${new Date().toISOString().split('T')[0]}.md`;
            downloadAsFile(content, filename, 'text/markdown');

            showToast('Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c xu·∫•t', 'success');
        }

        /**
         * Switch between tabs
         */
        function switchTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Remove active class from all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to selected tab button
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Add active class to selected tab content
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
        }

        /**
         * Load test cases (sample data for now)
         */
        function loadTestCases() {
            const sampleTestCases = [
                {
                    id: 1,
                    title: "Ki·ªÉm tra ƒëƒÉng nh·∫≠p v·ªõi th√¥ng tin h·ª£p l·ªá",
                    steps: "1. M·ªü trang ƒëƒÉng nh·∫≠p\n2. Nh·∫≠p email h·ª£p l·ªá\n3. Nh·∫≠p m·∫≠t kh·∫©u ƒë√∫ng\n4. Nh·∫•n n√∫t ƒêƒÉng nh·∫≠p\n5. Ki·ªÉm tra chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ch·ªß",
                    created_at: "2024-01-15T10:30:00Z",
                    updated_at: "2024-01-15T10:30:00Z"
                },
                {
                    id: 2,
                    title: "Ki·ªÉm tra ƒëƒÉng nh·∫≠p v·ªõi email kh√¥ng h·ª£p l·ªá",
                    steps: "1. M·ªü trang ƒëƒÉng nh·∫≠p\n2. Nh·∫≠p email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng\n3. Nh·∫≠p m·∫≠t kh·∫©u\n4. Nh·∫•n n√∫t ƒêƒÉng nh·∫≠p\n5. Ki·ªÉm tra hi·ªÉn th·ªã th√¥ng b√°o l·ªói",
                    created_at: "2024-01-15T10:35:00Z",
                    updated_at: "2024-01-15T10:35:00Z"
                },
                {
                    id: 3,
                    title: "Ki·ªÉm tra ƒëƒÉng nh·∫≠p v·ªõi m·∫≠t kh·∫©u sai",
                    steps: "1. M·ªü trang ƒëƒÉng nh·∫≠p\n2. Nh·∫≠p email h·ª£p l·ªá\n3. Nh·∫≠p m·∫≠t kh·∫©u sai\n4. Nh·∫•n n√∫t ƒêƒÉng nh·∫≠p\n5. Ki·ªÉm tra hi·ªÉn th·ªã th√¥ng b√°o l·ªói m·∫≠t kh·∫©u",
                    created_at: "2024-01-15T10:40:00Z",
                    updated_at: "2024-01-15T10:40:00Z"
                },
                {
                    id: 4,
                    title: "Ki·ªÉm tra ƒëƒÉng nh·∫≠p v·ªõi tr∆∞·ªùng tr·ªëng",
                    steps: "1. M·ªü trang ƒëƒÉng nh·∫≠p\n2. ƒê·ªÉ tr·ªëng email\n3. ƒê·ªÉ tr·ªëng m·∫≠t kh·∫©u\n4. Nh·∫•n n√∫t ƒêƒÉng nh·∫≠p\n5. Ki·ªÉm tra hi·ªÉn th·ªã th√¥ng b√°o y√™u c·∫ßu nh·∫≠p th√¥ng tin",
                    created_at: "2024-01-15T10:45:00Z",
                    updated_at: "2024-01-15T10:45:00Z"
                },
                {
                    id: 5,
                    title: "Ki·ªÉm tra ch·ª©c nƒÉng nh·ªõ m·∫≠t kh·∫©u",
                    steps: "1. M·ªü trang ƒëƒÉng nh·∫≠p\n2. Nh·∫≠p th√¥ng tin h·ª£p l·ªá\n3. T√≠ch ch·ªçn 'Nh·ªõ m·∫≠t kh·∫©u'\n4. ƒêƒÉng nh·∫≠p th√†nh c√¥ng\n5. ƒê√≥ng tr√¨nh duy·ªát v√† m·ªü l·∫°i\n6. Ki·ªÉm tra t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p",
                    created_at: "2024-01-15T10:50:00Z",
                    updated_at: "2024-01-15T10:50:00Z"
                }
            ];

            displayTestCases(sampleTestCases);
        }

        /**
         * Display test cases in table
         */
        function displayTestCases(testCases) {
            const container = document.getElementById('testCasesContainer');

            if (testCases.length === 0) {
                showEmptyState(
                    container,
                    'Ch∆∞a c√≥ Test Case n√†o',
                    'AI Agent ch∆∞a t·∫°o Test Case cho y√™u c·∫ßu n√†y',
                    {
                        text: 'üöÄ G·ª≠i cho AI Agent',
                        onclick: 'sendToAgent()'
                    }
                );
                return;
            }

            container.innerHTML = `
                <div class="test-cases-table-wrapper">
                    <table class="test-cases-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th style="width: 300px;">Ti√™u ƒë·ªÅ Test Case</th>
                                <th>C√°c b∆∞·ªõc th·ª±c hi·ªán</th>
                                <th style="width: 150px;">Ng√†y t·∫°o</th>
                                <th style="width: 150px;">C·∫≠p nh·∫≠t</th>
                                <th style="width: 100px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${testCases.map(testCase => `
                                <tr>
                                    <td class="text-center">${testCase.id}</td>
                                    <td>
                                        <div class="test-case-title">${testCase.title}</div>
                                    </td>
                                    <td>
                                        <div class="test-case-steps">
                                            ${testCase.steps.split('\n').map(step =>
                `<div class="step-item">${step}</div>`
            ).join('')}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <small>${formatDateTime(testCase.created_at)}</small>
                                    </td>
                                    <td class="text-center">
                                        <small>${formatDateTime(testCase.updated_at)}</small>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-secondary" onclick="viewTestCase(${testCase.id})" title="Xem chi ti·∫øt">
                                            üëÅÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="editTestCase(${testCase.id})" title="Ch·ªânh s·ª≠a">
                                            ‚úèÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666;">
                    <small>T·ªïng c·ªông: ${testCases.length} Test Case(s)</small>
                </div>
            `;
        }

        /**
         * Refresh test cases
         */
        async function refreshTestCases() {
            // TODO: Replace with actual API call
            // const testCases = await apiClient.getTestCases(conversationId);
            loadTestCases();
            showToast('Test Cases ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi', 'success');
        }

        /**
         * View test case details
         */
        function viewTestCase(testCaseId) {
            showToast(`Xem chi ti·∫øt Test Case #${testCaseId}`, 'info');
            // TODO: Implement view test case modal or navigation
        }

        /**
         * Edit test case
         */
        function editTestCase(testCaseId) {
            showToast(`Ch·ªânh s·ª≠a Test Case #${testCaseId}`, 'info');
            // TODO: Implement edit test case functionality
        }

        // File attachment variables
        let currentAttachedFile = null;

        /**
         * Trigger file selection
         */
        function triggerFileSelect() {
            const fileInput = document.getElementById('messageFileInput');
            fileInput.click();
        }

        /**
         * Handle file selection
         */
        function handleFileSelect() {
            const fileInput = document.getElementById('messageFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                currentAttachedFile = file;
                showFilePreview(file);
            }
        }

        /**
         * Show file preview
         */
        function showFilePreview(file) {
            const preview = document.getElementById('fileAttachmentPreview');
            const fileName = document.getElementById('attachedFileName');
            const fileSize = document.getElementById('attachedFileSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
            preview.style.display = 'block';
        }

        /**
         * Remove file attachment
         */
        function removeFileAttachment() {
            const fileInput = document.getElementById('messageFileInput');
            const preview = document.getElementById('fileAttachmentPreview');
            
            currentAttachedFile = null;
            fileInput.value = '';
            preview.style.display = 'none';
        }

        /**
         * Get message text from custom input
         */
        function getMessageText() {
            const inputArea = document.getElementById('messageInputArea');
            return inputArea.textContent.trim();
        }

        /**
         * Clear message input
         */
        function clearMessageInput() {
            const inputArea = document.getElementById('messageInputArea');
            inputArea.textContent = '';
        }

        /**
         * Send message (edit request) to AI Agent
         */
        async function sendMessage() {
            const sendBtn = document.getElementById('sendMessageBtn');
            const prompt = getMessageText();

            if (!prompt) {
                showToast('Vui l√≤ng nh·∫≠p n·ªôi dung tin nh·∫Øn', 'warning');
                return;
            }

            if (isStreaming) {
                showToast('ƒêang x·ª≠ l√Ω y√™u c·∫ßu tr∆∞·ªõc ƒë√≥...', 'warning');
                return;
            }

            if (!conversationId) {
                showToast('Kh√¥ng t√¨m th·∫•y conversation ID', 'error');
                return;
            }

            // Set loading state
            isStreaming = true;
            setCustomInputLoadingState(true);
            updateStatus('connecting', 'ƒêang k·∫øt n·ªëi...');

            // Update send button
            sendBtn.disabled = true;
            sendBtn.innerHTML = '‚è≥ ƒêang g·ª≠i...';

            // Clear input and disable it
            clearMessageInput();

            // Add user message to chat with loading indicator
            let displayMessage = prompt;
            if (currentAttachedFile) {
                displayMessage += `\n\nüìé ƒê√≠nh k√®m: ${currentAttachedFile.name} (${(currentAttachedFile.size / 1024).toFixed(1)} KB)`;
            }
            addStreamingMessage('user', displayMessage, true);

            // Add typing indicator
            addTypingIndicator();

            try {
                // Prepare API call with file if available
                let response;
                if (currentAttachedFile) {
                    response = await apiClient.editTestCaseWithFile(conversationId, prompt, currentAttachedFile);
                } else {
                    response = await apiClient.editTestCase(conversationId, prompt);
                }

                updateStatus('streaming', 'AI ƒëang tr·∫£ l·ªùi...');

                // Remove typing indicator before processing response
                removeTypingIndicator();

                // Process streaming response
                await processStreamingResponse(response);

                // Clear file attachment after successful send and processing
                removeFileAttachment();

            } catch (error) {
                console.error('Error sending message:', error);
                updateStatus('error', 'C√≥ l·ªói x·∫£y ra');
                removeTypingIndicator();
                addStreamingMessage('error', `‚ùå L·ªói: ${error.message}`);
            } finally {
                // Reset UI state
                isStreaming = false;
                setCustomInputLoadingState(false);
                updateStatus('idle', 'S·∫µn s√†ng');

                // Reset send button
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'üöÄ G·ª≠i tin nh·∫Øn';
            }
        }

        /**
         * Set custom input loading state
         */
        function setCustomInputLoadingState(isLoading) {
            const inputContainer = document.querySelector('.custom-message-input-container');
            const inputArea = document.getElementById('messageInputArea');
            const sendBtn = document.getElementById('sendMessageBtn');
            const attachBtn = document.getElementById('attachFileBtn');

            if (isLoading) {
                inputContainer.classList.add('loading');
                inputArea.classList.add('loading');
                inputArea.contentEditable = false;
                attachBtn.disabled = true;
            } else {
                inputContainer.classList.remove('loading');
                inputArea.classList.remove('loading');
                inputArea.contentEditable = true;
                attachBtn.disabled = false;
            }
        }

        /**
         * Add typing indicator to chat
         */
        function addTypingIndicator() {
            const container = document.getElementById('messagesContainer');
            
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message assistant typing';
            typingDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-role">ü§ñ AI Agent</span>
                    <span class="message-time">ƒëang tr·∫£ l·ªùi...</span>
                </div>
                <div class="message-content typing-dots">
                    <span class="typing-dot">‚óè</span>
                    <span class="typing-dot">‚óè</span>
                    <span class="typing-dot">‚óè</span>
                    <span style="margin-left: 5px;">AI ƒëang suy nghƒ©...</span>
                </div>
            `;

            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;

            // Add CSS for typing animation
            if (!document.querySelector('#typingAnimation')) {
                const style = document.createElement('style');
                style.id = 'typingAnimation';
                style.textContent = `
                    .typing-dots {
                        display: flex;
                        align-items: center;
                        color: #666;
                        font-style: italic;
                    }
                    .typing-dot {
                        animation: typingDot 1.4s infinite ease-in-out;
                        margin-right: 2px;
                        opacity: 0.4;
                    }
                    .typing-dot:nth-child(1) { animation-delay: 0s; }
                    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
                    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
                    @keyframes typingDot {
                        0%, 80%, 100% { opacity: 0.4; }
                        40% { opacity: 1; }
                    }
                    .message.typing {
                        background-color: #f0f0f0;
                        border-left: 3px solid #007bff;
                    }
                    .user-loading-dots {
                        animation: userLoadingDots 1.5s infinite;
                        color: #007bff;
                        font-weight: bold;
                        margin-left: 3px;
                    }
                    @keyframes userLoadingDots {
                        0%, 33% { opacity: 0.3; }
                        34%, 66% { opacity: 0.7; }
                        67%, 100% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        /**
         * Remove typing indicator from chat
         */
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Add keyboard support and event listeners for custom input
        document.addEventListener('DOMContentLoaded', function() {
            // File input event listener
            const fileInput = document.getElementById('messageFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }

            // Custom input area keyboard support
            const messageInputArea = document.getElementById('messageInputArea');
            if (messageInputArea) {
                messageInputArea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // Auto-resize handling for contenteditable
                messageInputArea.addEventListener('input', function() {
                    // Let CSS handle the max-height with overflow
                    this.style.height = 'auto';
                });
            }
        });

        // Initialize status
        updateStatus('idle', 'S·∫µn s√†ng');
    </script>
</body>

</html>
