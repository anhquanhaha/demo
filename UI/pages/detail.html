<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case AI Agent - Chi tiáº¿t yÃªu cáº§u</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Test Case AI Agent</h1>
            <p id="headerSubtitle">Chi tiáº¿t yÃªu cáº§u</p>
        </div>

        <div class="main-content">
            <div class="nav-bar">
                <div class="nav-title">
                    <a href="../index.html" class="btn btn-secondary">â† Quay láº¡i</a>
                    <span id="requestTitle">Äang táº£i...</span>
                </div>
                <div class="nav-actions">
                    <button class="btn btn-success" onclick="sendToAgent()" id="sendToAgentBtn">
                        ğŸš€ Gá»­i cho AI Agent
                    </button>
                    <button class="btn btn-secondary" onclick="refreshMessages()">
                        ğŸ”„ LÃ m má»›i
                    </button>
                </div>
            </div>

            <!-- Main Layout: Left Panel (Tabs) + Right Panel (Chat) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; min-height: 600px;">
                <!-- Left Panel: Tab Content -->
                <div style="background: #f8f9fa; border-right: 1px solid #e9ecef;">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-button active" onclick="switchTab('request-info')" id="tab-request-info">
                            ğŸ“‹ ThÃ´ng tin yÃªu cáº§u
                        </button>
                        <button class="tab-button" onclick="switchTab('test-cases')" id="tab-test-cases">
                            ğŸ§ª Test Cases
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content-container">
                        <!-- Tab 1: Request Info -->
                        <div id="tab-content-request-info" class="tab-content active">
                            <div style="padding: 30px;">
                                <h3 style="margin-bottom: 20px; color: #333;">ğŸ“‹ ThÃ´ng tin yÃªu cáº§u</h3>

                                <div id="requestInfo">
                                    <!-- Request info will be loaded here -->
                                </div>

                                <div style="margin-top: 30px;">
                                    <h4 style="margin-bottom: 15px; color: #333;">ğŸ“ Gá»­i file Ä‘Ã­nh kÃ¨m</h4>
                                    <div class="form-group">
                                        <div class="file-input-wrapper">
                                            <div class="file-input">
                                                <input type="file" id="fileAttachment"
                                                    accept="image/*,.txt,.md,.json,.xml">
                                                <span id="fileLabel">ğŸ“ Chá»n file Ä‘á»ƒ táº£i lÃªn</span>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">Há»— trá»£: áº¢nh, Text, Markdown, JSON, XML</small>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 2: Test Cases -->
                        <div id="tab-content-test-cases" class="tab-content">
                            <div style="padding: 30px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h3 style="color: #333;">ğŸ§ª Test Cases Ä‘Æ°á»£c táº¡o bá»Ÿi AI Agent</h3>
                                    <button class="btn btn-primary" onclick="refreshTestCases()">
                                        ğŸ”„ LÃ m má»›i
                                    </button>
                                </div>

                                <div id="testCasesContainer">
                                    <!-- Test cases table will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Chat (Always Visible) -->
                <div style="padding: 30px; background: #ffffff; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #333;">ğŸ’¬ Cuá»™c trÃ² chuyá»‡n vá»›i AI</h3>
                        <div>
                            <span class="status-indicator status-idle" id="statusIndicator"></span>
                            <span id="statusText">Sáºµn sÃ ng</span>
                        </div>
                    </div>

                    <div id="messagesContainer"
                        style="flex: 1; max-height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <!-- Messages will be loaded here -->
                    </div>

                    <!-- <div style="margin-top: 15px;">
                        <button class="btn btn-primary w-100" onclick="exportConversation()">
                            ğŸ“„ Xuáº¥t cuá»™c trÃ² chuyá»‡n
                        </button>
                    </div> -->

                    <!-- Khung chat tiáº¿p tá»¥c cuá»™c trÃ² chuyá»‡n cá»§a ngÆ°á»i dÃ¹ng -->
                    <div>
                        <textarea id="messageInput" placeholder="Nháº­p tin nháº¯n..."
                            style="width: 100%; height: 100px; margin-top: 15px; padding: 10px;"></textarea>
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="sendMessage()">Gá»­i</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentRequest = null;
        let currentMessages = [];
        let isStreaming = false;

        // Get conversation ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('id');

        if (!conversationId) {
            showToast('KhÃ´ng tÃ¬m tháº¥y ID yÃªu cáº§u', 'error');
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 2000);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadRequestData();
            setupFileInput();
            loadTestCases();
        });

        /**
         * Load request data and messages
         */
        async function loadRequestData() {
            try {
                // Load request info
                currentRequest = await apiClient.getRequest(conversationId);
                displayRequestInfo(currentRequest);

                // Load messages
                await loadMessages();

            } catch (error) {
                console.error('Error loading request data:', error);
                showToast('CÃ³ lá»—i khi táº£i dá»¯ liá»‡u: ' + error.message, 'error');
            }
        }

        /**
         * Display request information
         */
        function displayRequestInfo(request) {
            document.getElementById('requestTitle').textContent = request.title;
            document.getElementById('headerSubtitle').textContent = `Chi tiáº¿t yÃªu cáº§u: ${request.title}`;

            const requestInfo = document.getElementById('requestInfo');
            requestInfo.innerHTML = `
                <div class="mb-3">
                    <strong>TiÃªu Ä‘á»:</strong><br>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        ${request.title}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Conversation ID:</strong><br>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace; font-size: 0.9em;">
                        ${request.conversation_id}
                        <button class="btn btn-secondary btn-sm" style="margin-left: 10px;" 
                                onclick="copyToClipboard('${request.conversation_id}')" title="Sao chÃ©p ID">
                            ğŸ“‹
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>YÃªu cáº§u PBI:</strong><br>
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 5px; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                        ${request.pbi_requirement.replace(/\n/g, '<br>')}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em; color: #666;">
                    <div>
                        <strong>Táº¡o:</strong><br>
                        ${formatDateTime(request.created_at)}
                    </div>
                    <div>
                        <strong>Cáº­p nháº­t:</strong><br>
                        ${formatDateTime(request.updated_at)}
                    </div>
                </div>
            `;
        }

        /**
         * Load messages from API
         */
        async function loadMessages() {
            try {
                currentMessages = await apiClient.getMessages(conversationId);
                displayMessages(currentMessages);
            } catch (error) {
                console.error('Error loading messages:', error);
                const container = document.getElementById('messagesContainer');
                showError(container, 'CÃ³ lá»—i khi táº£i tin nháº¯n: ' + error.message);
            }
        }

        /**
         * Display messages in chat container
         */
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');

            if (messages.length === 0) {
                showEmptyState(
                    container,
                    'ChÆ°a cÃ³ tin nháº¯n nÃ o',
                    'Nháº¥n "Gá»­i cho AI Agent" Ä‘á»ƒ báº¯t Ä‘áº§u cuá»™c trÃ² chuyá»‡n',
                    {
                        text: 'ğŸš€ Gá»­i cho AI Agent',
                        onclick: 'sendToAgent()'
                    }
                );
                return;
            }

            container.innerHTML = messages.map(message => `
                <div class="message ${message.role}">
                    <div class="message-header">
                        <span class="message-role">
                            ${message.role === 'user' ? 'ğŸ‘¤ NgÆ°á»i dÃ¹ng' : 'ğŸ¤– AI Agent'}
                        </span>
                        <span class="message-time">${formatDateTime(message.created_at)}</span>
                    </div>
                    <div class="message-content">
                        ${message.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        /**
         * Setup file input handler
         */
        function setupFileInput() {
            const fileInput = document.getElementById('fileAttachment');
            const fileLabel = document.getElementById('fileLabel');

            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    fileLabel.textContent = `ğŸ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                } else {
                    fileLabel.textContent = 'ğŸ“ Chá»n file Ä‘á»ƒ táº£i lÃªn';
                }
            });
        }

        /**
         * Send request to AI Agent
         */
        async function sendToAgent() {
            if (isStreaming) {
                showToast('Äang xá»­ lÃ½ yÃªu cáº§u trÆ°á»›c Ä‘Ã³...', 'warning');
                return;
            }

            if (!currentRequest) {
                showToast('ChÆ°a táº£i Ä‘Æ°á»£c thÃ´ng tin yÃªu cáº§u', 'error');
                return;
            }

            isStreaming = true;
            updateStatus('connecting', 'Äang káº¿t ná»‘i...');

            const sendBtn = document.getElementById('sendToAgentBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'â³ Äang xá»­ lÃ½...';

            // Get file attachment
            const fileInput = document.getElementById('fileAttachment');
            const fileAttachment = fileInput.files[0] || null;

            try {
                const response = await apiClient.sendToAgent(
                    conversationId,
                    currentRequest.title,
                    currentRequest.pbi_requirement,
                    fileAttachment
                );

                updateStatus('streaming', 'Äang nháº­n dá»¯ liá»‡u...');

                // Clear file input
                fileInput.value = '';
                document.getElementById('fileLabel').textContent = 'ğŸ“ Chá»n file Ä‘á»ƒ táº£i lÃªn';

                // Process streaming response
                await processStreamingResponse(response);

            } catch (error) {
                console.error('Error sending to agent:', error);
                updateStatus('error', 'CÃ³ lá»—i xáº£y ra');
                addStreamingMessage('error', `âŒ Lá»—i: ${error.message}`);
            } finally {
                isStreaming = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'ğŸš€ Gá»­i cho AI Agent';
            }
        }

        /**
         * Process streaming response from agent
         */
        async function processStreamingResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let currentMessageContent = '';

            try {
                while (true) {
                    const { value, done } = await reader.read();

                    if (done) {
                        updateStatus('complete', 'HoÃ n thÃ nh');
                        break;
                    }

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleStreamData(data);
                            } catch (e) {
                                // Ignore JSON parse errors for incomplete chunks
                            }
                        }
                    }
                }
            } finally {
                // Reload messages to get the saved version
                setTimeout(() => {
                    loadMessages();
                }, 1000);
            }
        }

        /**
         * Handle streaming data
         */
        function handleStreamData(data) {
            switch (data.type) {
                case 'chunk':
                    appendToStreamingMessage(data.content);
                    break;

                case 'message':
                    addStreamingMessage('assistant', data.content);
                    break;

                case 'end':
                    updateStatus('complete', 'HoÃ n thÃ nh');
                    break;

                case 'error':
                    addStreamingMessage('error', `âŒ Lá»—i: ${data.message}`);
                    updateStatus('error', 'CÃ³ lá»—i xáº£y ra');
                    break;
            }
        }

        let currentStreamingMessage = null;

        /**
         * Add streaming message to chat
         */
        function addStreamingMessage(role, content) {
            const container = document.getElementById('messagesContainer');

            // Remove empty state if exists
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-role">
                        ${role === 'user' ? 'ğŸ‘¤ NgÆ°á»i dÃ¹ng' : role === 'assistant' ? 'ğŸ¤– AI Agent' : 'âš ï¸ Há»‡ thá»‘ng'}
                    </span>
                    <span class="message-time">${formatDateTime(new Date().toISOString())}</span>
                </div>
                <div class="message-content">${content}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            if (role === 'assistant') {
                currentStreamingMessage = messageDiv.querySelector('.message-content');
            }
        }

        /**
         * Append content to current streaming message
         */
        function appendToStreamingMessage(content) {
            if (!currentStreamingMessage) {
                // Create new streaming message
                addStreamingMessage('assistant', content);
            } else {
                currentStreamingMessage.textContent += content;
                const container = document.getElementById('messagesContainer');
                container.scrollTop = container.scrollHeight;
            }
        }

        /**
         * Update status indicator
         */
        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }

        /**
         * Refresh messages
         */
        async function refreshMessages() {
            await loadMessages();
            showToast('Tin nháº¯n Ä‘Ã£ Ä‘Æ°á»£c lÃ m má»›i', 'success');
        }

        /**
         * Export conversation to file
         */
        function exportConversation() {
            if (!currentRequest || currentMessages.length === 0) {
                showToast('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t', 'warning');
                return;
            }

            let content = `# ${currentRequest.title}\n\n`;
            content += `**Conversation ID:** ${currentRequest.conversation_id}\n`;
            content += `**Táº¡o:** ${formatDateTime(currentRequest.created_at)}\n`;
            content += `**Cáº­p nháº­t:** ${formatDateTime(currentRequest.updated_at)}\n\n`;
            content += `## YÃªu cáº§u PBI\n\n${currentRequest.pbi_requirement}\n\n`;
            content += `## Cuá»™c trÃ² chuyá»‡n\n\n`;

            currentMessages.forEach(message => {
                const role = message.role === 'user' ? 'ğŸ‘¤ NgÆ°á»i dÃ¹ng' : 'ğŸ¤– AI Agent';
                content += `### ${role} - ${formatDateTime(message.created_at)}\n\n`;
                content += `${message.content}\n\n---\n\n`;
            });

            const filename = `testcase_${currentRequest.conversation_id}_${new Date().toISOString().split('T')[0]}.md`;
            downloadAsFile(content, filename, 'text/markdown');

            showToast('Cuá»™c trÃ² chuyá»‡n Ä‘Ã£ Ä‘Æ°á»£c xuáº¥t', 'success');
        }

        /**
         * Switch between tabs
         */
        function switchTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Remove active class from all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to selected tab button
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Add active class to selected tab content
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
        }

        /**
         * Load test cases (sample data for now)
         */
        function loadTestCases() {
            const sampleTestCases = [
                {
                    id: 1,
                    title: "Kiá»ƒm tra Ä‘Äƒng nháº­p vá»›i thÃ´ng tin há»£p lá»‡",
                    steps: "1. Má»Ÿ trang Ä‘Äƒng nháº­p\n2. Nháº­p email há»£p lá»‡\n3. Nháº­p máº­t kháº©u Ä‘Ãºng\n4. Nháº¥n nÃºt ÄÄƒng nháº­p\n5. Kiá»ƒm tra chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang chá»§",
                    created_at: "2024-01-15T10:30:00Z",
                    updated_at: "2024-01-15T10:30:00Z"
                },
                {
                    id: 2,
                    title: "Kiá»ƒm tra Ä‘Äƒng nháº­p vá»›i email khÃ´ng há»£p lá»‡",
                    steps: "1. Má»Ÿ trang Ä‘Äƒng nháº­p\n2. Nháº­p email khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng\n3. Nháº­p máº­t kháº©u\n4. Nháº¥n nÃºt ÄÄƒng nháº­p\n5. Kiá»ƒm tra hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i",
                    created_at: "2024-01-15T10:35:00Z",
                    updated_at: "2024-01-15T10:35:00Z"
                },
                {
                    id: 3,
                    title: "Kiá»ƒm tra Ä‘Äƒng nháº­p vá»›i máº­t kháº©u sai",
                    steps: "1. Má»Ÿ trang Ä‘Äƒng nháº­p\n2. Nháº­p email há»£p lá»‡\n3. Nháº­p máº­t kháº©u sai\n4. Nháº¥n nÃºt ÄÄƒng nháº­p\n5. Kiá»ƒm tra hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i máº­t kháº©u",
                    created_at: "2024-01-15T10:40:00Z",
                    updated_at: "2024-01-15T10:40:00Z"
                },
                {
                    id: 4,
                    title: "Kiá»ƒm tra Ä‘Äƒng nháº­p vá»›i trÆ°á»ng trá»‘ng",
                    steps: "1. Má»Ÿ trang Ä‘Äƒng nháº­p\n2. Äá»ƒ trá»‘ng email\n3. Äá»ƒ trá»‘ng máº­t kháº©u\n4. Nháº¥n nÃºt ÄÄƒng nháº­p\n5. Kiá»ƒm tra hiá»ƒn thá»‹ thÃ´ng bÃ¡o yÃªu cáº§u nháº­p thÃ´ng tin",
                    created_at: "2024-01-15T10:45:00Z",
                    updated_at: "2024-01-15T10:45:00Z"
                },
                {
                    id: 5,
                    title: "Kiá»ƒm tra chá»©c nÄƒng nhá»› máº­t kháº©u",
                    steps: "1. Má»Ÿ trang Ä‘Äƒng nháº­p\n2. Nháº­p thÃ´ng tin há»£p lá»‡\n3. TÃ­ch chá»n 'Nhá»› máº­t kháº©u'\n4. ÄÄƒng nháº­p thÃ nh cÃ´ng\n5. ÄÃ³ng trÃ¬nh duyá»‡t vÃ  má»Ÿ láº¡i\n6. Kiá»ƒm tra tá»± Ä‘á»™ng Ä‘Äƒng nháº­p",
                    created_at: "2024-01-15T10:50:00Z",
                    updated_at: "2024-01-15T10:50:00Z"
                }
            ];

            displayTestCases(sampleTestCases);
        }

        /**
         * Display test cases in table
         */
        function displayTestCases(testCases) {
            const container = document.getElementById('testCasesContainer');

            if (testCases.length === 0) {
                showEmptyState(
                    container,
                    'ChÆ°a cÃ³ Test Case nÃ o',
                    'AI Agent chÆ°a táº¡o Test Case cho yÃªu cáº§u nÃ y',
                    {
                        text: 'ğŸš€ Gá»­i cho AI Agent',
                        onclick: 'sendToAgent()'
                    }
                );
                return;
            }

            container.innerHTML = `
                <div class="test-cases-table-wrapper">
                    <table class="test-cases-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th style="width: 300px;">TiÃªu Ä‘á» Test Case</th>
                                <th>CÃ¡c bÆ°á»›c thá»±c hiá»‡n</th>
                                <th style="width: 150px;">NgÃ y táº¡o</th>
                                <th style="width: 150px;">Cáº­p nháº­t</th>
                                <th style="width: 100px;">Thao tÃ¡c</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${testCases.map(testCase => `
                                <tr>
                                    <td class="text-center">${testCase.id}</td>
                                    <td>
                                        <div class="test-case-title">${testCase.title}</div>
                                    </td>
                                    <td>
                                        <div class="test-case-steps">
                                            ${testCase.steps.split('\n').map(step =>
                `<div class="step-item">${step}</div>`
            ).join('')}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <small>${formatDateTime(testCase.created_at)}</small>
                                    </td>
                                    <td class="text-center">
                                        <small>${formatDateTime(testCase.updated_at)}</small>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-secondary" onclick="viewTestCase(${testCase.id})" title="Xem chi tiáº¿t">
                                            ğŸ‘ï¸
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="editTestCase(${testCase.id})" title="Chá»‰nh sá»­a">
                                            âœï¸
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666;">
                    <small>Tá»•ng cá»™ng: ${testCases.length} Test Case(s)</small>
                </div>
            `;
        }

        /**
         * Refresh test cases
         */
        async function refreshTestCases() {
            // TODO: Replace with actual API call
            // const testCases = await apiClient.getTestCases(conversationId);
            loadTestCases();
            showToast('Test Cases Ä‘Ã£ Ä‘Æ°á»£c lÃ m má»›i', 'success');
        }

        /**
         * View test case details
         */
        function viewTestCase(testCaseId) {
            showToast(`Xem chi tiáº¿t Test Case #${testCaseId}`, 'info');
            // TODO: Implement view test case modal or navigation
        }

        /**
         * Edit test case
         */
        function editTestCase(testCaseId) {
            showToast(`Chá»‰nh sá»­a Test Case #${testCaseId}`, 'info');
            // TODO: Implement edit test case functionality
        }

        // Initialize status
        updateStatus('idle', 'Sáºµn sÃ ng');
    </script>
</body>

</html>